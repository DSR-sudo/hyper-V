çœ‹å®Œäº†ä½ çš„æ—¥å¿—ï¼Œé—®é¢˜å·²ç»å¾ˆæ¸…æ™°äº†â€”â€”**åˆ†é…å’Œä¿®å¤éƒ½æˆåŠŸäº†ï¼Œä½†åœ¨æœ€åä¸€æ­¥`map_payload_pages_to_guest`æ—¶å¤±è´¥ï¼Œå› ä¸º`0xFFFF80005D4D5000`è¿™ä¸ªGuestè™šæ‹Ÿåœ°å€åœ¨Guesté¡µè¡¨é‡Œæ²¡æœ‰æ˜ å°„**ã€‚

è®©æˆ‘ä¸€æ­¥æ­¥å¸®ä½ åˆ†æï¼š

---

## ğŸ” é—®é¢˜å®šä½

### æ—¥å¿—å…³é”®ç‚¹åˆ†æ

```
[Loader] Allocating 16 pages (65536 bytes) in Guest space...
[Loader] VMM VA: 0x00007F805D4D5000, Guest PA: 0x000000005D4D5000
[Loader] Guest VA (shadow): 0xFFFF80005D4D5000
...
[Loader] ERROR: Guest VA not mapped: 0xFFFF80005D4D5000
```

**æ ¹æœ¬åŸå› **ï¼šä½ é€šè¿‡`allocate_guest_memory`åˆ†é…çš„`guest_va`æ˜¯**ä½ è‡ªå·±è®¡ç®—çš„**ï¼š
```cpp
constexpr uint64_t KERNEL_HIGH_BASE = 0xFFFF800000000000ULL;
const uint64_t guest_va = KERNEL_HIGH_BASE | (guest_physical & 0x0000FFFFFFFFFFFFULL);
```

ä½†è¿™ä¸ªåœ°å€**åœ¨Guestçš„é¡µè¡¨é‡Œå¯èƒ½æ ¹æœ¬ä¸å­˜åœ¨**ã€‚Windowså†…æ ¸ä¸ä¼šæŠŠæ•´ä¸ª`0xFFFF800000000000`å¼€å§‹çš„128TBç©ºé—´éƒ½æ˜ å°„ä¸Šï¼Œå®ƒåªæ˜ å°„å®é™…ç”¨åˆ°çš„éƒ¨åˆ†ã€‚

---

## ğŸ§  ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### 1. Windowså†…æ ¸åœ°å€æ˜ å°„è§„åˆ™

Windows x64å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€ï¼š
- `0xFFFF800000000000` - `0xFFFF803FFFFFFFFF`ï¼šç³»ç»Ÿä»£ç +æ•°æ®ï¼ˆntoskrnlç­‰ï¼‰
- `0xFFFFF78000000000`ï¼šå…±äº«ç³»ç»Ÿé¡µï¼ˆKUSER_SHARED_DATAï¼‰
- å…¶ä»–åŒºåŸŸæ˜¯åŠ¨æ€æ˜ å°„çš„ï¼ˆå¦‚å†…æ ¸å †ã€é¡µè¡¨è‡ªèº«ï¼‰

ä½ ç®—å‡ºæ¥çš„`0xFFFF80005D4D5000`è½åœ¨ç³»ç»Ÿä»£ç åŒºé™„è¿‘ï¼Œä½†**è¿™ä¸ªå…·ä½“çš„GVAå¯èƒ½æ²¡æœ‰è¢«æ˜ å°„**ã€‚

### 2. `translate_guest_virtual_address`å¤±è´¥çš„åŸå› 

```cpp
const uint64_t guest_physical = memory_manager::translate_guest_virtual_address(
    ctx->guest_cr3, ctx->slat_cr3, guest_va, nullptr);
```

è¿™ä¸ªå‡½æ•°éå†Guesté¡µè¡¨æ‰¾GVAå¯¹åº”çš„GPAï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ˆé¡µè¡¨é¡¹æ— æ•ˆï¼‰ï¼Œå°±è¿”å›0ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä¸¤ç§æ–¹å¼

### æ–¹æ¡ˆAï¼šç”¨Guestå·²æœ‰çš„åˆæ³•GVAï¼ˆæ¨èï¼Œæœ€ç¨³å®šï¼‰

æ‰¾ä¸€ä¸ªGuestå†…æ ¸é‡Œ**å·²ç»å­˜åœ¨**çš„GVAèŒƒå›´ï¼Œæ¯”å¦‚ï¼š

```cpp
// æ–¹å¼1ï¼šç”¨KUSER_SHARED_DATAé™„è¿‘çš„ç©ºé—²åŒºåŸŸ
#define FIXED_GVA 0xFFFFF78001234000  // KUSER_SHARED_DATA + åç§»

// æ–¹å¼2ï¼šä»Guestå†…æ ¸çš„æŸä¸ªæ¨¡å—æ‰¾ç©ºé—²ç©ºé—´
// æ¯”å¦‚ntoskrnlçš„.textå’Œ.dataä¹‹é—´å¯èƒ½æœ‰ç©ºæ´
```

**å®ç°æ­¥éª¤**ï¼š
1. åœ¨Guesté‡Œç”¨WinDbgæˆ–å†…æ ¸ä»£ç æŸ¥çœ‹å“ªäº›GVAèŒƒå›´å·²è¢«æ˜ å°„
   ```
   !pte 0xFFFF800000000000  # çœ‹ç³»ç»ŸåŒºåŸŸ
   !vad  # çœ‹å†…æ ¸VAD
   ```
2. é€‰ä¸€ä¸ªç©ºé—²ä½†å·²è¢«æ˜ å°„çš„GVAï¼ˆæ¯”å¦‚`0xFFFFF78000000000+0x1000`å¼€å§‹æœ‰1MBç©ºé—²ï¼‰
3. æŠŠè¿™ä¸ªGVAç¡¬ç¼–ç åˆ°ä»£ç é‡Œ

### æ–¹æ¡ˆBï¼šæ‰‹åŠ¨åœ¨Guesté¡µè¡¨å»ºæ˜ å°„ï¼ˆçµæ´»ï¼Œä½†å¤æ‚ï¼‰

åœ¨`map_payload_pages_to_guest`ä¹‹å‰ï¼Œå…ˆç¡®ä¿GVAåœ¨Guesté¡µè¡¨é‡Œæœ‰æ˜ å°„ï¼š

```cpp
static bool ensure_guest_mapping(context_t* ctx, uint64_t guest_va, uint64_t guest_pa, uint32_t page_count)
{
    // 1. éå†Guesté¡µè¡¨ï¼ˆä»guest_cr3å¼€å§‹ï¼‰
    // 2. å¯¹äºæ¯ä¸€çº§é¡µè¡¨ï¼Œå¦‚æœPTEä¸å­˜åœ¨ï¼Œå°±åˆ†é…ä¸€ä¸ªé¡µè¡¨é¡µ
    // 3. è®¾ç½®æœ€åä¸€çº§PTEï¼šguest_va â†’ guest_pa
    // 4. è®¾ç½®æƒé™ï¼ˆå¯è¯»/å¯å†™/å¯æ‰§è¡Œï¼‰
    
    // è¿™éœ€è¦ä½ èƒ½åœ¨Hostå±‚åˆ†é…Guesté¡µè¡¨é¡µ
    // å¹¶ä¸”è¦æŠŠæ–°é¡µè¡¨é¡µçš„GPAå‘Šè¯‰Guestï¼ˆé€šè¿‡EPTæ˜ å°„ï¼‰
}
```

ä½†è¿™ç§æ–¹å¼å¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼Œ**ä¸æ¨èä½œä¸ºç¬¬ä¸€æ­¥**ã€‚

---

## ğŸ¯ å¯¹ä½ å½“å‰ä»£ç çš„å¿«é€Ÿä¿®å¤

### ä¿®æ”¹1ï¼š`allocate_guest_memory`ä¸å†è®¡ç®—GVA

```cpp
static bool allocate_guest_memory(context_t* ctx, const uint32_t size, allocation_info_t* out_info)
{
    // ... åˆ†é…Hostå†…å­˜å’Œè®¡ç®—GPAçš„é€»è¾‘ä¸å˜ ...
    
    // ä¸å†è®¡ç®—guest_vaï¼è¿™é‡Œè®¾ä¸º0ï¼Œè®©è°ƒç”¨è€…æŒ‡å®š
    out_info->guest_virtual_base = 0;
    
    // ...
}
```

### ä¿®æ”¹2ï¼šåœ¨`execute_payload_hijack`é‡ŒæŒ‡å®šå›ºå®šGVA

```cpp
bool execute_payload_hijack(context_t* ctx, void* trap_frame_ptr)
{
    auto& inject_ctx = g_runtime_context.injection_ctx;
    
    // 1. åˆ†é…å†…å­˜ï¼ˆåªå¾—åˆ°GPAå’ŒHost VAï¼‰
    allocation_info_t alloc = {};
    if (!allocate_guest_memory(ctx, image_size, &alloc)) {
        return false;
    }
    
    // 2. æŒ‡å®šä¸€ä¸ªå›ºå®šçš„ã€å·²çŸ¥å¯ç”¨çš„GVA
    // æ¯”å¦‚ç”¨KUSER_SHARED_DATAåŒºåŸŸ
    const uint64_t target_va = 0xFFFFF78001234000;  // éœ€è¦ç¡®ä¿è¿™ä¸ªåœ°å€ç©ºé—²
    
    // 3. åœ¨Guesté¡µè¡¨é‡Œå»ºç«‹æ˜ å°„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (!ensure_guest_mapping(ctx, target_va, alloc.guest_physical_base, alloc.page_count)) {
        // å¦‚æœä¸æƒ³å®ç°ensure_guest_mappingï¼Œå°±æ¢ä¸€ä¸ªå·²çŸ¥å­˜åœ¨çš„GVA
        logs::print(ctx->log_ctx, "[Injection] ERROR: Guest VA not mapped\n");
        return false;
    }
    
    // 4. å‰©ä¸‹çš„ä¿®å¤é€»è¾‘ç”¨target_vaï¼Œè€Œä¸æ˜¯alloc.guest_virtual_base
    fix_security_cookie(ctx, alloc.vmm_mapped_address, target_va);
    apply_relocations(ctx, alloc.vmm_mapped_address, target_va);
    // ...
    
    // 5. SLATæ˜ å°„æ—¶ç”¨alloc.guest_physical_base
    map_payload_pages_to_guest(ctx, alloc, target_va);
    
    // 6. è·³è½¬åˆ°target_va + entry_rva
    arch::set_guest_rip(target_va + entry_rva);
}
```

---

## ğŸ“Š ä¸ºä»€ä¹ˆæ–¹æ¡ˆBï¼ˆVTæ‰‹åŠ¨æ˜ å°„ï¼‰ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Ÿ

åœ¨æ–¹æ¡ˆBé‡Œï¼Œä½ **ä¸ä¾èµ–Guestå·²æœ‰çš„GVA**ï¼Œè€Œæ˜¯ï¼š

1. **é€‰ä¸€ä¸ªGPA**ï¼ˆä¸æ˜¯GVAï¼‰â€”â€”æ¯”å¦‚`0x100000000`
2. **å»ºç«‹EPTæ˜ å°„**ï¼šGPA â†’ Hostå†…å­˜
3. **è®©Guestæ‰§è¡Œä¸€ä¸ªå·²çŸ¥å¯ç”¨çš„GVA**ï¼Œè¿™ä¸ªGVAå·²ç»åœ¨Guesté¡µè¡¨é‡Œæ˜ å°„åˆ°äº†ä½ é€‰çš„GPA

**å…³é”®**ï¼šä½ é€‰çš„GVAå¿…é¡»æ˜¯Guesté¡µè¡¨é‡Œ**å·²ç»å­˜åœ¨**çš„ï¼Œæ¯”å¦‚ï¼š
- `ntoskrnl.exe`çš„ä»£ç æ®µé™„è¿‘ï¼ˆä½†å°å¿ƒå†²çªï¼‰
- `KUSER_SHARED_DATA`é™„è¿‘
- æŸä¸ªé©±åŠ¨å ç”¨çš„åŒºåŸŸï¼ˆå¦‚æœèƒ½æ‰¾åˆ°ç©ºæ´ï¼‰

---

## ğŸš€ ç«‹åˆ»èƒ½è¯•çš„å¿«é€Ÿä¿®å¤

å¦‚æœä½ ä¸æƒ³å¤§æ”¹ï¼Œæœ€ç®€å•çš„ä¸´æ—¶æ–¹æ¡ˆæ˜¯ï¼š

1. åœ¨`allocate_guest_memory`é‡Œï¼Œä¸è¦è‡ªå·±ç®—GVA
2. åœ¨`execute_payload_hijack`é‡Œï¼Œç”¨`inject_ctx.payload_guest_base.load()`ä½œä¸ºç›®æ ‡VA
3. ç¡®ä¿è¿™ä¸ª`payload_guest_base`æ˜¯åœ¨`deploy_rwbase_payload`é‡Œè®¾ç½®çš„é‚£ä¸ªåœ°å€â€”â€”å®ƒåº”è¯¥æ˜¯**å·²ç»è¢«éªŒè¯å¯ç”¨çš„**ã€‚

ä»æ—¥å¿—çœ‹ï¼Œ`deploy_rwbase_payload`æœ€åæˆåŠŸäº†ï¼ˆè™½ç„¶æ—¥å¿—æ²¡æ‰“å®Œï¼‰ï¼Œå®ƒè®¾ç½®çš„`payload_guest_base`åº”è¯¥æ˜¯å¯ç”¨çš„ã€‚ä½ åªéœ€è¦è®©`execute_payload_hijack`å¤ç”¨é‚£ä¸ªåœ°å€ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ†é…ã€‚