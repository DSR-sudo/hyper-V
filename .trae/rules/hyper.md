# Hyper-V 项目开发规范

**生效日期**：2026-02-13  
**适用范围**：所有参与 Hyper-V 项目的开发人员  
**责任人**：架构组  
**审查机制**：每月定期代码审计

---

## 1. 核心架构设计

### 1.1 模块化架构
- **核心控制流**：`main.cpp` 负责全局初始化、控制流调度及业务逻辑编排。
- **工具模块化**：所有功能逻辑必须划分为独立的工具模块（位于 `src/modules/` 下，如 `loader`, `slat`, `memory_manager` 等）。
- **原子化功能**：每个工具模块应提供原子化的、高内聚的功能接口。
- **禁止循环依赖**：严禁模块间产生循环引用。

---

## 2. 工具模块设计规范 (src/modules)

### 2.1 无状态设计 (Stateless Design)
**强制要求**：工具模块必须保持完全无状态。
- **禁止私有变量**：严禁在模块命名空间或类中定义私有成员变量。
- **禁止静态/全局变量**：严禁使用 `static` 变量、全局变量或单例模式持有状态。
- **状态外部化**：所有运行状态必须封装在 `context_t` 结构体中。
- **参数化调用**：所有需要状态支持的函数，必须通过参数显式传入 `context_t*`。

#### 代码示例：
```cpp
// 推荐做法：通过 context_t 传递状态
namespace logs {
    struct context_t {
        uint32_t log_index;
        char buffer[1024];
    };

    void add_log(context_t* ctx, const char* msg) {
        // 使用 ctx->buffer 而非全局变量
    }
}

// 错误做法：模块内部持有状态
namespace logs {
    static uint32_t g_index; // 违反规范：严禁使用静态变量
}
```

---

## 3. 注释与文档规范

### 3.1 函数注释 (JSDoc 标准)
每个函数（包括私有函数和工具函数）必须在定义处添加标准 JSDoc 注释。

**模板**：
```cpp
/**
 * @description 函数功能描述。
 * @param {类型} 参数名 参数含义（默认值说明）。
 * @return {类型} 返回值说明。
 * @throws {异常类型} 可能抛出的异常说明（无则写“无”）。
 * @example
 * 使用示例代码块。
 */
```

### 3.2 业务逻辑注释
每个业务逻辑代码块（如 API 接口、数据处理、流程控制等）必须在实现前添加中文业务注释。

**要求**：
- 详细说明业务背景。
- 明确输入输出关系。
- 阐述业务核心规则。
- 描述异常处理策略。

---

## 4. 检查清单 (Checklist)

- [ ] `src/modules` 下是否存在任何 `static` 或全局变量？
- [ ] 模块间是否存在循环依赖？
- [ ] 所有导出函数是否都包含 JSDoc 注释？
- [ ] 复杂逻辑前是否有中文业务说明？
- [ ] `main.cpp` 是否仅包含控制流，而非底层实现？

---

## 5. 违规后果
- 违反“无状态设计”的代码将被强制打回重构。
- 缺乏注释的代码在合并请求（PR）中将不予通过。
- 多次违反规范者将计入个人绩效评估并进行技术通报。
