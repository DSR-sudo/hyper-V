Hyper-V Project Detailed Architecture Map
========================================

.
├── .trae/
│   └── rules/
│       └── hyper.md                    # 项目编码规范与模块化设计准则
├── hyperv-attachment/                  # 核心 hypervisor 逻辑
│   ├── src/
│   │   ├── apic/                       # APIC (中断控制器) 处理
│   │   │   ├── apic.cpp                # APIC 基类与 xAPIC/x2APIC 实现
│   │   │   ├── apic.h                  # 接口: apic_t (send_ipi, send_nmi, create_instance), xapic_t, x2apic_t
│   │   │   ├── apic_def.h              # APIC 相关寄存器与位域结构定义
│   │   │   └── apic_intrin.h           # APIC 相关的编译器内联函数封装
│   │   ├── arch/                       # 硬件架构抽象层
│   │   │   ├── arch.cpp                # 架构相关功能的通用入口实现
│   │   │   ├── arch.h                  # 接口: arch::get_vmexit_reason, arch::get_guest_cr3, arch::set_slat_cr3
│   │   │   └── amd_def.h               # AMD VMCB 与相关标志位定义
│   │   ├── crt/                        # 自定义 C 运行时 (无依赖)
│   │   │   ├── crt.cpp                 # 内存操作与同步原语实现
│   │   │   └── crt.h                   # 接口: crt::copy_memory, crt::set_memory, crt::mutex_t, crt::bitmap_t
│   │   ├── hypercall/                  # Hypercall 处理
│   │   │   └── hypercall.h             # 接口: hypercall::process (处理来自 Guest 的调用)
│   │   ├── interrupts/                 # 中断与 NMI 处理
│   │   │   └── interrupts.h            # 接口: interrupts::set_up, interrupts::process_nmi, interrupts::send_nmi_all_but_self
│   │   ├── loader/                     # 影子映射器与 Payload 加载引擎
│   │   │   ├── cookie.cpp              # Security Cookie 修复逻辑
│   │   │   ├── cookie.h                # 接口: loader::fix_security_cookie
│   │   │   ├── deployer.cpp            # Payload 部署协调器
│   │   │   ├── deployer.h              # 接口: loader::deploy_dkom_payload, loader::deploy_rwbase_payload
│   │   │   ├── guest.cpp               # Guest 内核模块发现逻辑
│   │   │   ├── guest.h                 # 接口: loader::init_guest_discovery, loader::find_guest_module
│   │   │   ├── imports.cpp             # 内核导出函数解析实现
│   │   │   ├── imports.h               # 接口: loader::resolve_payload_imports, loader::get_kernel_export
│   │   │   ├── loader.h                # 统一加载器头文件
│   │   │   ├── pe.h                    # PE 文件结构定义 (无 STL 依赖)
│   │   │   ├── reloc.cpp               # 重定位应用逻辑
│   │   │   └── reloc.h                 # 接口: loader::apply_relocations
│   │   ├── logs/                       # 日志系统
│   │   │   ├── logs.cpp                # 日志缓冲与 Guest 同步实现
│   │   │   └── logs.h                  # 接口: logs::add_log, logs::flush, logs::print
│   │   ├── memory_manager/             # 内存管理
│   │   │   ├── heap_manager.h          # 堆内存分配器接口
│   │   │   ├── memory_manager.h        # 接口: memory_manager::map_guest_physical, memory_manager::translate_guest_virtual_address
│   │   ├── runtime/                    # 运行时分发与验证
│   │   │   ├── payload_validation.h    # Payload 完整性校验
│   │   │   └── vmexit_dispatch.h       # VMExit 事件分发逻辑
│   │   ├── slat/                       # 第二级地址转换 (EPT/NPT)
│   │   │   ├── cr3/                    # 页表操作
│   │   │   │   ├── cr3.cpp             # 页表基址管理
│   │   │   │   ├── cr3.h               # 接口: slat::cr3::get_pml4_address
│   │   │   │   ├── deep_copy.h         # 页表深拷贝接口 (用于隐藏页面)
│   │   │   │   ├── pte.cpp             # 页表项操作
│   │   │   │   └── pte.h               # 接口: slat::pte::get_entry, slat::pte::set_entry
│   │   │   ├── hook/                   # SLAT 钩子机制
│   │   │   │   ├── amd_page_split.h    # AMD 架构页面分割逻辑
│   │   │   │   ├── hook.cpp            # 钩子安装与管理
│   │   │   │   ├── hook.h              # 接口: slat::hook::install, slat::hook::remove
│   │   │   │   └── hook_entry.h        # 钩子条目结构定义
│   │   │   ├── violation/              # SLAT 违例处理
│   │   │   │   └── violation.h         # 接口: slat::violation::handler
│   │   │   ├── slat.cpp                # SLAT 初始化与核心翻译逻辑
│   │   │   ├── slat.h                  # 接口: slat::set_up, slat::hide_physical_page_from_guest
│   │   │   └── slat_def.h              # SLAT 相关位域与宏定义
│   │   ├── structures/                 # 核心数据结构
│   │   │   └── virtual_address.h       # 虚拟地址分解结构 (PML4/PDPT/PD/PT)
│   │   ├── arch_config.h               # 架构配置开关
│   │   └── main.cpp                    # 模块入口 (entry_point), 初始化所有子系统
│   └── ext/                            # 外部架构文档
│       └── ia32-doc/                   # IA32 架构定义
├── shared/                             # Guest 与 Host 共享的接口定义
│   ├── hypercall/
│   │   └── hypercall_def.h             # 接口: hypercall_type_t (功能号定义), hypercall_info_t
│   ├── payload/
│   │   └── payload_bin.h               # 内嵌的二进制 Payload 数据
│   └── structures/
│       ├── memory_operation.h          # 接口: memory_operation_t (读/写操作定义)
│       └── trap_frame.h                # 接口: trap_frame_t, nmi_trap_frame_t (寄存器状态保存)
├── uefi-boot/                          # UEFI 引导程序 (基于 EDK2)
│   └── ext/                            # 外部库依赖 (EDK2, OpenSSL, ia32-doc)
├── images/                             # 项目说明图片 (AMD/Intel SLAT Violation 等)
├── scripts/                            # 自动化脚本 (Payload 生成等)
├── .gitignore
├── .gitmodules
├── LICENSE
├── README.md
├── _internal_build.cmd                 # 内部构建批处理
├── hyper-reV.sln                       # Visual Studio 解决方案
└── load-hyper-reV.bat                  # 驱动加载/注入脚本
